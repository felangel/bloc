---
title: Flutter Firebase Login
description:
  Guida completa alla creazione di un flusso di login Flutter con bloc e Firebase.
sidebar:
  order: 7
---

import RemoteCode from '~/components/code/RemoteCode.astro';
import FlutterCreateSnippet from '~/components/tutorials/flutter-firebase-login/FlutterCreateSnippet.astro';
import FlutterPubGetSnippet from '~/components/tutorials/FlutterPubGetSnippet.astro';

![advanced](https://img.shields.io/badge/level-advanced-red.svg)

In questo tutorial costruiremo in Flutter un flusso di accesso al sistema tramite Firebase 
usando la libreria bloc.

![demo](~/assets/tutorials/flutter-firebase-login.gif)

## Argomenti Chiave

- [BlocProvider](/it/flutter-bloc-concepts#blocprovider), widget Flutter che
  fornisce un'istanza di bloc ai suoi figli;
- Usare Cubit invece di Bloc.
  [Qual è la differenza?](/it/bloc-concepts#cubit-vs-bloc);
- Aggiungere eventi con [context.read](/it/flutter-bloc-concepts#contextread);
- Prevenire aggiornamenti non necessari con [Equatable](/it/faqs#when-to-use-equatable);
- [RepositoryProvider](/it/flutter-bloc-concepts#repositoryprovider), widget Flutter
  che fornisce un repository ai suoi figli;
- [BlocListener](/it/flutter-bloc-concepts#bloclistener), widget Flutter che
  invoca codice in risposta ai cambiamenti di stato nel bloc;
- Aggiungere eventi con [context.read](/it/flutter-bloc-concepts#contextselect).

## Configurazione

Inizieremo creando un nuovo progetto Flutter.

<FlutterCreateSnippet />

Proprio come nel [tutorial login](/it/tutorials/flutter-login), creeremo
pacchetti interni per strutturare meglio l'architettura dell'applicazione e
mantenere confini chiari, massimizzando la riutilizzabilità e migliorando
la testabilità.

In questo caso, i pacchetti [firebase_auth](https://pub.dev/packages/firebase_auth) e
[google_sign_in](https://pub.dev/packages/google_sign_in) costituiranno
il nostro livello dati; creeremo quindi un
`AuthenticationRepository` per comporre i dati provenienti dai due client API.

## Authentication Repository

L'`AuthenticationRepository` ha la responsabilità di astrarre i dettagli implementativi
dell'autenticazione e del recupero delle informazioni utente.

In questo caso si integrerà con Firebase, ma potremo cambiare l'implementazione interna in futuro senza influenzare il resto dell'applicazione.

### Configurazione

Inizieremo creando la cartella `packages/authentication_repository` e un
`pubspec.yaml` alla radice del progetto.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/packages/authentication_repository/pubspec.yaml"
	title="packages/authentication_repository/pubspec.yaml"
/>

Successivamente, possiamo installare le dipendenze eseguendo:

<FlutterPubGetSnippet />

nella directory `authentication_repository`.

Come la maggior parte dei pacchetti, l'`authentication_repository` definirà la sua superficie API
tramite `packages/authentication_repository/lib/authentication_repository.dart`.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/packages/authentication_repository/lib/authentication_repository.dart"
	title="packages/authentication_repository/lib/authentication_repository.dart"
/>

:::note

Il pacchetto `authentication_repository` esporrà un
`AuthenticationRepository` e i relativi modelli.

:::

Diamo ora un'occhiata ai modelli.

### User

Il modello `User` descriverà un utente nel contesto del dominio di autenticazione.

Per gli scopi di questo esempio, un utente sarà composto da `email`,
`id`, `name` e `photo`.

:::note

Sta a te definire come deve essere un utente nel contesto del tuo dominio.

:::

[user.dart](https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/packages/authentication_repository/lib/src/models/user.dart ':include')

:::note

La classe `User` estende [equatable](https://pub.dev/packages/equatable) per
sovrascrivere i confronti di uguaglianza, permettendoci di confrontare diverse
istanze di `User` per valore.

:::

:::tip

È utile definire un `User` vuoto `static` per evitare di gestire
`User` null e lavorare sempre con un oggetto `User` concreto.

:::

### Repository

L'`AuthenticationRepository` ha il compito di astrarre l'implementazione sottostante
dell'autenticazione e di recuperare l'utente.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/packages/authentication_repository/lib/src/authentication_repository.dart"
	title="packages/authentication_repository/lib/src/authentication_repository.dart"
/>

L'`AuthenticationRepository` espone uno `Stream<User>` a cui possiamo sottoscriverci
per essere notificati quando un `User` cambia.

Inoltre, espone metodi per `signUp`, `logInWithGoogle`, `logInWithEmailAndPassword` e `logOut`.

:::note

L'`AuthenticationRepository` è anche responsabile della gestione degli errori di basso livello
che possono verificarsi nel livello dati, esponendo un set pulito e semplice di errori
allineati con il dominio.

:::

Questo è tutto per l'`AuthenticationRepository`. Vediamo ora come
integrarlo nel progetto Flutter che abbiamo creato.

## Configurazione Firebase

Dobbiamo seguire le
[istruzioni di utilizzo firebase_auth](https://pub.dev/packages/firebase_auth#usage)
per collegare la nostra applicazione a Firebase e abilitare
[google_sign_in](https://pub.dev/packages/google_sign_in).

:::caution

Ricorda di aggiornare il `google-services.json` su Android e i file
`GoogleService-Info.plist` e `Info.plist` su iOS, altrimenti l'applicazione
andrà in crash.

:::

## Dipendenze del Progetto

Possiamo sostituire il `pubspec.yaml` generato alla radice del progetto con il
seguente:

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/pubspec.yaml"
	title="pubspec.yaml"
/>

Nota che stiamo specificando una directory assets per tutti gli asset
locali delle nostre applicazioni.

Crea una directory `assets` alla radice del tuo progetto e aggiungi
l'asset [bloc logo](https://github.com/felangel/bloc/blob/master/examples/flutter_firebase_login/assets/bloc_logo_small.png)
(che useremo più tardi).

Poi installa tutte le dipendenze:

<FlutterPubGetSnippet />

:::note

Dipendiamo dal pacchetto `authentication_repository` tramite path; questo
ci permetterà di iterare rapidamente mantenendo una separazione chiara.

:::

## main.dart

Il file `main.dart` può essere sostituito con il seguente:

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/main.dart"
	title="lib/main.dart"
/>

Qui impostiamo alcune configurazioni globali per l'applicazione e chiamiamo
`runApp` con un'istanza di `App`.

:::note

Stiamo iniettando una singola istanza di `AuthenticationRepository` nell'`App`
come dipendenza esplicita del costruttore.

:::

## App

Proprio come nel [tutorial login](/it/tutorials/flutter-login), il nostro file `app.dart` fornisce all'applicazione un'istanza di `AuthenticationRepository` tramite `RepositoryProvider` e crea un'istanza di `AuthenticationBloc` rendendola disponibile.

Successivamente, `AppView` utilizza l'`AuthenticationBloc` per
gestire l'aggiornamento della route corrente in base all'`AuthenticationState`.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/app/view/app.dart"
	title="lib/app/view/app.dart"
/>

## App Bloc

L'`AppBloc` è responsabile della gestione dello stato globale dell'applicazione.

Ha una dipendenza dall'`AuthenticationRepository` e si sottoscrive allo
stream `user` per emettere nuovi stati in risposta ai cambiamenti dell'utente corrente.

### State

L'`AppState` consiste in un `AppStatus` e un `User`. Il costruttore di default
accetta un `User` opzionale e reindirizza al costruttore privato con lo
stato di autenticazione appropriato.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/app/bloc/app_state.dart"
	title="lib/app/bloc/app_state.dart"
/>

### Event

L'`AppEvent` ha due sottoclassi:

- `AppUserSubscriptionRequested`: notifica il bloc di sottoscriversi allo stream utente;
- `AppLogoutPressed`: notifica il bloc di un'azione di logout dell'utente.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/app/bloc/app_event.dart"
	title="lib/app/bloc/app_event.dart"
/>

### Bloc

Nel corpo del costruttore, le sottoclassi di `AppEvent` sono mappate ai loro gestori di eventi corrispondenti.

Nel gestore `_onUserSubscriptionRequested`, l'`AppBloc` usa
`emit.onEach` per sottoscriversi allo stream utente dell'`AuthenticationRepository`
ed emettere uno stato in risposta a ogni `User`.

`emit.onEach` crea internamente una sottoscrizione allo stream e si occupa di
cancellarla quando l'`AppBloc` o lo stream utente vengono chiusi.

Se lo stream utente emette un errore, `addError` inoltra l'errore e lo stack trace
a qualsiasi `BlocObserver` in ascolto.

:::caution

Se `onError` viene omesso, eventuali errori sullo stream utente sono considerati non gestiti
e saranno lanciati da `onEach`.
Di conseguenza, la sottoscrizione allo stream utente verrà cancellata.

:::

:::tip

Un [`BlocObserver`](/it/bloc-concepts/#blocobserver-1) è ottimo per registrare eventi Bloc,
errori e cambiamenti di stato, specialmente nel contesto di analytics e crash reporting.

:::

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/app/bloc/app_bloc.dart"
	title="lib/app/bloc/app_bloc.dart"
/>

## Modelli

Modelli di input per `Email` e `Password` sono utili per incapsulare la
logica di validazione e saranno usati sia nel `LoginForm` che nel `SignUpForm`
(più avanti nel tutorial).

Entrambi i modelli di input sono realizzati usando il pacchetto [formz](https://pub.dev/packages/formz)
e ci permettono di lavorare con un oggetto validato piuttosto che con un tipo
primitivo come `String`.

### Email

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/packages/form_inputs/lib/src/email.dart"
	title="packages/form_inputs/lib/src/email.dart"
/>

### Password

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/packages/form_inputs/lib/src/password.dart"
	title="packages/form_inputs/lib/src/password.dart"
/>

## Login Page

La `LoginPage` è responsabile della creazione e fornitura di un'istanza di
`LoginCubit` al `LoginForm`.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/login/view/login_page.dart"
	title="lib/login/view/login_page.dart"
/>

:::tip

È molto importante mantenere la creazione di bloc/cubit separata da dove
vengono consumati.
Questo ti permetterà di iniettare facilmente istanze fittizie (mock) e testare
la tua vista in isolamento.

:::

## Login Cubit

Il `LoginCubit` gestisce il `LoginState` del form.

Espone API per `logInWithCredentials`, `logInWithGoogle`, e viene
notificato quando email o password vengono aggiornate.

### State

Il `LoginState` consiste in `Email`, `Password` e `FormzStatus`. I
modelli `Email` e `Password` estendono `FormzInput` dal
pacchetto [formz](https://pub.dev/packages/formz).

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/login/cubit/login_state.dart"
	title="lib/login/cubit/login_state.dart"
/>

### Cubit

Il `LoginCubit` ha una dipendenza dall'`AuthenticationRepository` per
accedere all'utente tramite credenziali o tramite Google Sign In.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/login/cubit/login_cubit.dart"
	title="lib/login/cubit/login_cubit.dart"
/>

:::note

Abbiamo usato un `Cubit` invece di un `Bloc` perché il `LoginState` è piuttosto
semplice e localizzato.
Anche senza eventi, possiamo intuire cosa è successo osservando i cambiamenti di stato; inoltre, il nostro codice risulta più semplice e conciso.

:::

## Login Form

Il `LoginForm` renderizza il form in base al `LoginState` e invoca metodi sul `LoginCubit` in risposta alle interazioni dell'utente.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/login/view/login_form.dart"
	title="lib/login/view/login_form.dart"
/>

Il `LoginForm` renderizza anche un pulsante "Create Account" che naviga alla
`SignUpPage`, dove un utente può creare un nuovo account.

## Sign Up Page

La struttura `SignUp` rispecchia quella di `Login` e consiste in
`SignUpPage`, `SignUpView` e `SignUpCubit`.

La `SignUpPage` è responsabile solo di creare e fornire un'istanza del
`SignUpCubit` al `SignUpForm` (esattamente come in `LoginPage`).

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/sign_up/view/sign_up_page.dart"
	title="lib/sign_up/view/sign_up_page.dart"
/>

:::note

Così come il `LoginCubit`, anche il `SignUpCubit` dipende dall'`AuthenticationRepository` per la creazione di nuovi utenti.

:::

## Sign Up Cubit

Il `SignUpCubit` gestisce lo stato del `SignUpForm` e comunica con
l'`AuthenticationRepository` per creare nuovi utenti.

### State

Il `SignUpState` riutilizza gli stessi modelli di input form `Email` e `Password`
perché la logica di validazione è identica.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/sign_up/cubit/sign_up_state.dart"
	title="lib/sign_up/cubit/sign_up_state.dart"
/>

### Cubit

Il `SignUpCubit` è estremamente simile al `LoginCubit`, con la principale
eccezione che espone un'API per inviare il form di registrazione anziché di login.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/sign_up/cubit/sign_up_cubit.dart"
	title="lib/sign_up/cubit/sign_up_cubit.dart"
/>

## Sign Up Form

Il `SignUpForm` è responsabile del rendering del form in risposta al
`SignUpState` e invoca metodi sul `SignUpCubit` in risposta alle interazioni dell'utente.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/sign_up/view/sign_up_form.dart"
	title="lib/sign_up/view/sign_up_form.dart"
/>

## Home Page

Dopo che un utente accede o si registra con successo, lo stream `user` sarà
aggiornato.
Questo porterà a un cambiamento di stato nell'`AuthenticationBloc` e
farà sì che l'`AppView` mostri la `HomePage`.

Dalla `HomePage`, l'utente può visualizzare le informazioni del proprio profilo e disconnettersi toccando l'icona di uscita nella `AppBar`.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/home/view/home_page.dart"
	title="lib/home/view/home_page.dart"
/>

:::note

Una directory `widgets` è stata creata insieme alla directory `view` all'interno della funzionalità `home` per componenti riutilizzabili specifici di quella funzionalità.
In questo caso un semplice widget `Avatar` è esportato e usato all'interno della `HomePage`.

:::

:::note

Quando viene toccato l'`IconButton` di logout, un evento `AuthenticationLogoutRequested` viene aggiunto all'`AuthenticationBloc`, che disconnette l'utente e lo riporta alla `LoginPage`.

:::

A questo punto abbiamo un'implementazione di login solida usando Firebase e abbiamo
disaccoppiato il livello di presentazione dalla logica applicativa usando la
Libreria Bloc.

Il codice sorgente completo per questo esempio può essere trovato
[qui](https://github.com/felangel/bloc/tree/master/examples/flutter_firebase_login).
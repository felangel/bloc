---
title: تسجيل الدخول باستخدام Flutter و Firebase
description:
  دليل متعمق حول كيفية بناء تدفق تسجيل دخول في Flutter باستخدام مكتبتي Bloc و
  Firebase.
sidebar:
  order: 7
---

import RemoteCode from '~/components/code/RemoteCode.astro';
import FlutterCreateSnippet from '~/components/tutorials/flutter-firebase-login/FlutterCreateSnippet.astro';
import FlutterPubGetSnippet from '~/components/tutorials/FlutterPubGetSnippet.astro';

![advanced](https://img.shields.io/badge/level-advanced-red.svg)

في هذا الدليل، سنقوم ببناء **تدفق تسجيل دخول باستخدام Firebase في Flutter**
بالاستعانة بمكتبة **Bloc**.

![demo](~/assets/tutorials/flutter-firebase-login.gif)

## المواضيع الرئيسية

- [BlocProvider](/flutter-bloc-concepts#blocprovider)، وهي ويدجت (Widget) من
  Flutter توفر كتلة (Bloc) لأبنائها.
- استخدام Cubit بدلاً من Bloc. [ما هو الفرق؟](/bloc-concepts#cubit-vs-bloc)
- إضافة الأحداث باستخدام [context.read](/flutter-bloc-concepts#contextread).
- منع إعادة البناء غير الضرورية باستخدام
  [Equatable](/faqs#when-to-use-equatable).
- [RepositoryProvider](/flutter-bloc-concepts#repositoryprovider)، وهي ويدجت من
  Flutter توفر مستودع (Repository) لأبنائها.
- [BlocListener](/flutter-bloc-concepts#bloclistener)، وهي ويدجت من Flutter
  تستدعي كود المستمع (listener) استجابةً لتغيرات الحالة في الكتلة (Bloc).
- إضافة الأحداث باستخدام [context.read](/flutter-bloc-concepts#contextselect).

## الإعداد

سنبدأ بإنشاء مشروع Flutter جديد تمامًا.

<FlutterCreateSnippet />

تمامًا كما في [دليل تسجيل الدخول](/tutorials/flutter-login)، سنقوم بإنشاء حزم
داخلية لتقسيم بنية تطبيقنا بشكل أفضل والحفاظ على حدود واضحة، ولزيادة قابلية
إعادة الاستخدام وقابلية الاختبار.

في هذه الحالة، ستكون حزمتا
[firebase_auth](https://pub.dev/packages/firebase_auth) و
[google_sign_in](https://pub.dev/packages/google_sign_in) هما طبقة البيانات
لدينا، لذا سنقوم بإنشاء `AuthenticationRepository` فقط لتجميع البيانات من عميلي
(clients) واجهة برمجة التطبيقات (API) هذين.

## مستودع المصادقة (Authentication Repository)

سيكون `AuthenticationRepository` مسؤولاً عن تجريد تفاصيل التنفيذ الداخلية لكيفية
مصادقة المستخدم وجلب معلوماته. في هذه الحالة، سيتم التكامل مع Firebase، ولكن
يمكننا دائمًا تغيير التنفيذ الداخلي لاحقًا ولن يتأثر تطبيقنا.

### الإعداد

سنبدأ بإنشاء `packages/authentication_repository` وملف `pubspec.yaml` في جذر
المشروع.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/packages/authentication_repository/pubspec.yaml"
	title="packages/authentication_repository/pubspec.yaml"
/>

بعد ذلك، يمكننا تثبيت التبعيات عن طريق تشغيل:

<FlutterPubGetSnippet />

في مجلد `authentication_repository`.

تمامًا مثل معظم الحزم، سيحدد `authentication_repository` واجهة برمجة التطبيقات
الخاصة به عبر
`packages/authentication_repository/lib/authentication_repository.dart`

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/packages/authentication_repository/lib/authentication_repository.dart"
	title="packages/authentication_repository/lib/authentication_repository.dart"
/>

:::note

ستقوم حزمة `authentication_repository` بكشف `AuthenticationRepository` بالإضافة
إلى النماذج (models).

:::

بعد ذلك، دعونا نلقي نظرة على النماذج.

### المستخدم (User)

سيصف نموذج `User` المستخدم في سياق نطاق المصادقة. لأغراض هذا المثال، سيتكون
المستخدم من `email` و `id` و `name` و `photo`.

:::note

الأمر متروك لك تمامًا لتحديد الشكل الذي يجب أن يبدو عليه المستخدم في سياق نطاق
عملك.

:::

[user.dart](https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/packages/authentication_repository/lib/src/models/user.dart ':include')

:::note

يرث صنف `User` من [equatable](https://pub.dev/packages/equatable) من أجل تجاوز
مقارنات التساوي بحيث يمكننا مقارنة مثيلات مختلفة من `User` حسب القيمة.

:::

:::tip

من المفيد تعريف `User` فارغ `static` حتى لا نضطر إلى التعامل مع المستخدمين
`null` ويمكننا دائمًا العمل مع كائن `User` ملموس.

:::

### المستودع (Repository)

إن `AuthenticationRepository` مسؤول عن تجريد التنفيذ الأساسي لكيفية مصادقة
المستخدم، وكذلك كيفية جلب المستخدم.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/packages/authentication_repository/lib/src/authentication_repository.dart"
	title="packages/authentication_repository/lib/src/authentication_repository.dart"
/>

يكشف `AuthenticationRepository` عن `Stream<User>` يمكننا الاشتراك فيه لتلقي
إشعارات عندما يتغير `User`. بالإضافة إلى ذلك، فإنه يكشف عن طرق لـ `signUp` و
`logInWithGoogle` و `logInWithEmailAndPassword` و `logOut`.

:::note

إن `AuthenticationRepository` مسؤول أيضًا عن التعامل مع الأخطاء منخفضة المستوى
التي يمكن أن تحدث في طبقة البيانات ويكشف عن مجموعة نظيفة وبسيطة من الأخطاء التي
تتوافق مع نطاق العمل.

:::

هذا كل شيء بالنسبة لـ `AuthenticationRepository`. بعد ذلك، دعونا نلقي نظرة على
كيفية دمجه في مشروع Flutter الذي أنشأناه.

## إعداد Firebase

نحتاج إلى اتباع
[تعليمات استخدام firebase_auth](https://pub.dev/packages/firebase_auth#usage) من
أجل ربط تطبيقنا بـ Firebase وتمكين
[google_sign_in](https://pub.dev/packages/google_sign_in).

:::caution

تذكر تحديث `google-services.json` على Android و `GoogleService-Info.plist` و
`Info.plist` على iOS، وإلا سيتعطل التطبيق.

:::

## تبعيات المشروع (Project Dependencies)

يمكننا استبدال ملف `pubspec.yaml` الذي تم إنشاؤه في جذر المشروع بما يلي:

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/pubspec.yaml"
	title="pubspec.yaml"
/>

لاحظ أننا نحدد مجلد الأصول (assets) لجميع الأصول المحلية لتطبيقاتنا. قم بإنشاء
مجلد `assets` في جذر مشروعك وأضف أصل
[شعار bloc](https://github.com/felangel/bloc/blob/master/examples/flutter_firebase_login/assets/bloc_logo_small.png)
(الذي سنستخدمه لاحقًا).

ثم قم بتثبيت جميع التبعيات:

<FlutterPubGetSnippet />

:::note

نحن نعتمد على حزمة `authentication_repository` عبر المسار (path)، مما سيسمح لنا
بالتكرار بسرعة مع الحفاظ على فصل واضح.

:::

## main.dart

يمكن استبدال ملف `main.dart` بما يلي:

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/main.dart"
	title="lib/main.dart"
/>

إنه يقوم ببساطة بإعداد بعض التكوينات العامة للتطبيق واستدعاء `runApp` مع مثيل من
`App`.

:::note

نحن نقوم بحقن مثيل واحد من `AuthenticationRepository` في `App` وهو تبعية صريحة
للمنشئ (constructor dependency).

:::

## التطبيق (App)

تمامًا كما في [دليل تسجيل الدخول](/tutorials/flutter-login)، سيوفر ملف
`app.dart` الخاص بنا مثيلاً من `AuthenticationRepository` للتطبيق عبر
`RepositoryProvider`، كما يقوم بإنشاء وتوفير مثيل من `AuthenticationBloc`. بعد
ذلك، تستهلك `AppView` كتلة `AuthenticationBloc` وتتولى تحديث المسار الحالي بناءً
على `AuthenticationState`.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/app/view/app.dart"
	title="lib/app/view/app.dart"
/>

## كتلة التطبيق (App Bloc)

إن `AppBloc` مسؤول عن إدارة الحالة العامة للتطبيق. لديه تبعية على
`AuthenticationRepository` ويشترك في دفق `user` من أجل إصدار حالات جديدة
استجابةً للتغييرات في المستخدم الحالي.

### الحالة (State)

تتكون `AppState` من `AppStatus` و `User`. يقبل المنشئ الافتراضي `User` اختياريًا
ويعيد التوجيه إلى المنشئ الخاص مع حالة المصادقة المناسبة.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/app/bloc/app_state.dart"
	title="lib/app/bloc/app_state.dart"
/>

### الحدث (Event)

يحتوي `AppEvent` على فئتين فرعيتين:

- `AppUserSubscriptionRequested` التي تخبر الكتلة (bloc) بالاشتراك في دفق
  المستخدم.
- `AppLogoutPressed` التي تخبر الكتلة بإجراء تسجيل خروج للمستخدم.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/app/bloc/app_event.dart"
	title="lib/app/bloc/app_event.dart"
/>

### الكتلة (Bloc)

في جسم المنشئ (constructor body)، يتم تعيين الفئات الفرعية لـ `AppEvent`
لمعالجات الأحداث المقابلة لها.

في معالج الحدث `_onUserSubscriptionRequested`، يستخدم `AppBloc` الدالة
`emit.onEach` للاشتراك في دفق المستخدم الخاص بـ `AuthenticationRepository`
وإصدار حالة استجابةً لكل `User`.

تقوم `emit.onEach` بإنشاء اشتراك دفق داخليًا وتتولى إلغاءه عند إغلاق `AppBloc`
أو دفق المستخدم.

إذا أصدر دفق المستخدم خطأً، فإن `addError` يعيد توجيه الخطأ وتتبع المكدس (stack
trace) إلى أي `BlocObserver` يستمع.

:::caution

إذا تم حذف `onError`، فسيتم اعتبار أي أخطاء في دفق المستخدم غير معالجة، وسيتم
طرحها بواسطة `onEach`. ونتيجة لذلك، سيتم إلغاء الاشتراك في دفق المستخدم.

:::

:::tip

يعد [`BlocObserver`](/bloc-concepts/#blocobserver-1) رائعًا لتسجيل أحداث Bloc
والأخطاء وتغييرات الحالة، خاصة في سياق التحليلات وتقارير الأعطال.

:::

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/app/bloc/app_bloc.dart"
	title="lib/app/bloc/app_bloc.dart"
/>

## النماذج (Models)

يعد نموذج إدخال `Email` و `Password` مفيدًا لتغليف منطق التحقق من الصحة
(validation logic) وسيتم استخدامه في كل من `LoginForm` و `SignUpForm` (في وقت
لاحق من الدليل).

يتم إنشاء كلا نموذجي الإدخال باستخدام حزمة
[formz](https://pub.dev/packages/formz) ويسمحان لنا بالعمل مع كائن تم التحقق من
صحته بدلاً من نوع بدائي مثل `String`.

### البريد الإلكتروني (Email)

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/packages/form_inputs/lib/src/email.dart"
	title="packages/form_inputs/lib/src/email.dart"
/>

### كلمة المرور (Password)

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/packages/form_inputs/lib/src/password.dart"
	title="packages/form_inputs/lib/src/password.dart"
/>

## صفحة تسجيل الدخول (Login Page)

إن `LoginPage` مسؤولة عن إنشاء وتوفير مثيل من `LoginCubit` إلى `LoginForm`.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/login/view/login_page.dart"
	title="lib/login/view/login_page.dart"
/>

:::tip

من المهم جدًا إبقاء عملية إنشاء الكتل/الـ Cubits منفصلة عن مكان استهلاكها. سيسمح
لك هذا بحقن مثيلات وهمية (mock instances) بسهولة واختبار العرض الخاص بك بمعزل عن
غيره.

:::

## Login Cubit

إن `LoginCubit` مسؤول عن إدارة `LoginState` للنموذج. يكشف عن واجهات برمجة
تطبيقات لـ `logInWithCredentials` و `logInWithGoogle`، بالإضافة إلى تلقي إشعارات
عند تحديث البريد الإلكتروني/كلمة المرور.

### الحالة (State)

تتكون `LoginState` من `Email` و `Password` و `FormzStatus`. يوسع نموذجا `Email`
و `Password` من `FormzInput` من حزمة [formz](https://pub.dev/packages/formz).

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/login/cubit/login_state.dart"
	title="lib/login/cubit/login_state.dart"
/>

### Cubit

لدى `LoginCubit` تبعية على `AuthenticationRepository` من أجل تسجيل دخول المستخدم
إما عبر بيانات الاعتماد أو عبر تسجيل الدخول باستخدام Google.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/login/cubit/login_cubit.dart"
	title="lib/login/cubit/login_cubit.dart"
/>

:::note

لقد استخدمنا `Cubit` بدلاً من `Bloc` هنا لأن `LoginState` بسيط ومحلي إلى حد ما.
حتى بدون الأحداث، لا يزال بإمكاننا الحصول على فكرة جيدة عما حدث بمجرد النظر إلى
التغييرات من حالة إلى أخرى، ويكون الكود الخاص بنا أبسط وأكثر إيجازًا.

:::

## نموذج تسجيل الدخول (Login Form)

إن `LoginForm` مسؤول عن عرض النموذج استجابةً لـ `LoginState` ويستدعي طرقًا على
`LoginCubit` استجابةً لتفاعلات المستخدم.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/login/view/login_form.dart"
	title="lib/login/view/login_form.dart"
/>

يعرض `LoginForm` أيضًا زر "إنشاء حساب" (Create Account) الذي ينتقل إلى
`SignUpPage` حيث يمكن للمستخدم إنشاء حساب جديد تمامًا.

## صفحة التسجيل (Sign Up Page)

يعكس هيكل `SignUp` هيكل `Login` ويتكون من `SignUpPage` و `SignUpView` و
`SignUpCubit`.

إن `SignUpPage` مسؤولة فقط عن إنشاء وتوفير مثيل من `SignUpCubit` إلى
`SignUpForm` (تمامًا كما في `LoginPage`).

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/sign_up/view/sign_up_page.dart"
	title="lib/sign_up/view/sign_up_page.dart"
/>

:::note

تمامًا كما في `LoginCubit`، لدى `SignUpCubit` تبعية على
`AuthenticationRepository` من أجل إنشاء حسابات مستخدمين جديدة.

:::

## SignUp Cubit

يدير `SignUpCubit` حالة `SignUpForm` ويتواصل مع `AuthenticationRepository` من
أجل إنشاء حسابات مستخدمين جديدة.

### الحالة (State)

تُعيد `SignUpState` استخدام نفس نماذج إدخال النموذج `Email` و `Password` لأن
منطق التحقق من الصحة هو نفسه.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/sign_up/cubit/sign_up_state.dart"
	title="lib/sign_up/cubit/sign_up_state.dart"
/>

### Cubit

إن `SignUpCubit` مشابه للغاية لـ `LoginCubit` مع استثناء رئيسي وهو أنه يكشف عن
واجهة برمجة تطبيقات لإرسال النموذج بدلاً من تسجيل الدخول.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/sign_up/cubit/sign_up_cubit.dart"
	title="lib/sign_up/cubit/sign_up_cubit.dart"
/>

## نموذج التسجيل (Sign Up Form)

إن `SignUpForm` مسؤول عن عرض النموذج استجابةً لـ `SignUpState` ويستدعي طرقًا على
`SignUpCubit` استجابةً لتفاعلات المستخدم.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/sign_up/view/sign_up_form.dart"
	title="lib/sign_up/view/sign_up_form.dart"
/>

## الصفحة الرئيسية (Home Page)

بعد أن يقوم المستخدم بتسجيل الدخول أو التسجيل بنجاح، سيتم تحديث دفق `user` مما
سيؤدي إلى تغيير الحالة في `AuthenticationBloc` وسيؤدي إلى دفع `HomePage` إلى
مكدس التنقل بواسطة `AppView`.

من `HomePage`، يمكن للمستخدم عرض معلومات ملفه الشخصي وتسجيل الخروج من خلال النقر
على أيقونة الخروج في `AppBar`.

<RemoteCode
	url="https://raw.githubusercontent.com/felangel/bloc/master/examples/flutter_firebase_login/lib/home/view/home_page.dart"
	title="lib/home/view/home_page.dart"
/>

:::note

تم إنشاء مجلد `widgets` جنبًا إلى جنب مع مجلد `view` ضمن ميزة `home` للمكونات
القابلة لإعادة الاستخدام والخاصة بتلك الميزة المعينة. في هذه الحالة، يتم تصدير
ويدجت `Avatar` بسيط واستخدامه داخل `HomePage`.

:::

:::note

عند النقر على `IconButton` الخاص بتسجيل الخروج، يتم إضافة حدث
`AuthenticationLogoutRequested` إلى `AuthenticationBloc` الذي يقوم بتسجيل خروج
المستخدم وإعادته إلى `LoginPage`.

:::

في هذه المرحلة، لدينا تطبيق تسجيل دخول قوي إلى حد ما باستخدام Firebase وقمنا
بفصل طبقة العرض لدينا عن طبقة منطق الأعمال باستخدام مكتبة Bloc.

يمكن العثور على المصدر الكامل لهذا المثال
[هنا](https://github.com/felangel/bloc/tree/master/examples/flutter_firebase_login).
